generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}



model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      String     @default("CUSTOMER") // ADMIN, CUSTOMER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // Relations

  subscription Subscription?
  orders       Order[]
  tickets      SupportTicket[]
  credits      CreditLedger[]
  addresses    Address[]
  paymentMethods PaymentMethod[]
  adminAuditLogs AdminAuditLog[]
}

model Address {
  id           String @id @default(uuid())
  userId       String
  title        String // e.g. "Ev", "İş"
  fullAddress  String
  city         String
  district     String
  zipCode      String?
  instructions String?
  user         User   @relation(fields: [userId], references: [id])
}

model PaymentMethod {
  id        String @id @default(uuid())
  userId    String
  cardLast4 String
  cardBrand String
  isDefault Boolean @default(false)
  user      User   @relation(fields: [userId], references: [id])
}

// Replaced by Plan-linked Subscription below


model Plan {
  id               String   @id @default(uuid())
  name             String
  slug             String   @unique // e.g., "2-people-3-meals"
  personCount      Int
  mealsPerWeek     Int
  basePriceTRY     Decimal
  pricePerServingTRY Decimal
  deliveryFeeTRY   Decimal
  isActive         Boolean  @default(true)
  
  subscriptions    Subscription[]
}

model Recipe {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  description String
  imageUrl    String
  timeMinutes Int
  difficulty  String // EASY, MEDIUM, HARD
  spiceLevel  String // NONE, MILD, MEDIUM, HOT
  proteinType String // BEEF, CHICKEN, FISH, VEGGIE, VEGAN
  calories    Int?
  nutrition   String?  // JSON string for macros
  allergens   String?  // JSON string array
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())

  ingredients RecipeIngredient[]
  steps       RecipeStep[]
  menuItems   MenuWeekRecipe[]
}

model Ingredient {
  id   String @id @default(uuid())
  name String @unique
  unit String // g, ml, adet

  recipes RecipeIngredient[]
}

model RecipeIngredient {
  id           String     @id @default(uuid())
  recipeId     String
  ingredientId String
  amount       Float
  recipe       Recipe     @relation(fields: [recipeId], references: [id])
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
}

model RecipeStep {
  id          String @id @default(uuid())
  recipeId    String
  stepNumber  Int
  instruction String
  timerSeconds Int?
  recipe      Recipe @relation(fields: [recipeId], references: [id])
}

model MenuWeekRecipe {
  id         String @id @default(uuid())
  menuWeekId String
  recipeId   String
  collection String // "İmza Tabaklar", "Sokak Lezzetleri" etc.
  
  menuWeek   MenuWeek @relation(fields: [menuWeekId], references: [id])
  recipe     Recipe   @relation(fields: [recipeId], references: [id])
}

model MenuWeek {
  id           String   @id @default(uuid())
  year         Int
  weekNumber   Int
  weekStartDate DateTime
  cutoffDate   DateTime
  city         String?  // For multi-zone support
  zone         String?
  isPublished  Boolean  @default(false)
  isLocked     Boolean  @default(false)
  
  recipes      MenuWeekRecipe[]
  orders       Order[]

  @@unique([year, weekNumber, zone])
}

model Subscription {
  id           String   @id @default(uuid())
  userId       String   @unique
  planId       String
  isActive     Boolean  @default(true)
  status       String   @default("ACTIVE") // ACTIVE, PAUSED, CANCELLED
  nextDeliveryDate DateTime?
  deliveryZone String?
  deliveryDay  String?
  deliveryWindow String?
  
  user         User     @relation(fields: [userId], references: [id])
  plan         Plan     @relation(fields: [planId], references: [id])
}

model Order {
  id            String      @id @default(uuid())
  userId        String
  menuWeekId    String?
  status        String @default("PENDING") // PENDING, PAID, PREPARING, SHIPPED, DELIVERED, CANCELLED, REFUNDED
  paymentStatus String      @default("UNPAID")
  totalAmount   Decimal
  deliveryDate  DateTime
  deliveryAddress SnapshotAddress? // Embedded JSON or relation logic
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  items         OrderItem[]
  events        OrderEvent[]
  user          User        @relation(fields: [userId], references: [id])
  menuWeek      MenuWeek?   @relation(fields: [menuWeekId], references: [id])
  couponId      String?
  coupon        Coupon?     @relation(fields: [couponId], references: [id])
}

model OrderEvent {
  id        String   @id @default(uuid())
  orderId   String
  type      String   // STATUS_CHANGE, PAYMENT, REFUND
  notes     String?
  createdAt DateTime @default(now())
  
  order     Order    @relation(fields: [orderId], references: [id])
}

model SnapshotAddress {
  id          String @id @default(uuid())
  orderId     String @unique
  fullAddress String
  city        String
  district    String
  zipCode     String?
  title       String?
  
  order       Order @relation(fields: [orderId], references: [id])
}

model AdminAuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String   // PUBLISH_MENU, REFUND_ORDER, LOCK_WEEK
  resource  String   // Entity ID target
  details   String?
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id])
}

model OrderItem {
  id        String @id @default(uuid())
  orderId   String
  recipeId  String // Snapshot of recipe
  quantity  Int
  order     Order  @relation(fields: [orderId], references: [id])
}



model CreditLedger {
  id        String   @id @default(uuid())
  userId    String
  amount    Decimal
  reason    String
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id])
}



// --- PHASE 4 EXTENSIONS ---

model Coupon {
  id          String   @id @default(uuid())
  code        String   @unique
  discountType String  // PERCENT, FIXED
  value       Decimal
  minBasket   Decimal  @default(0)
  maxUsage    Int      @default(999999)
  usedCount   Int      @default(0)
  expiresAt   DateTime
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  orders      Order[]
}

model SupportTicket {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  orderId     String?
  subject     String
  category    String   // MISSING_ITEM, DELIVERY, QUALITY, BILLING, OTHER
  status      String   @default("OPEN") // OPEN, IN_PROGRESS, CLOSED
  priority    String   @default("NORMAL") // LOW, NORMAL, HIGH
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  messages    TicketMessage[]
}

model TicketMessage {
  id          String   @id @default(uuid())
  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  senderId    String   // Could be userId or adminId, simpler to just store string 'USER' or 'ADMIN' for v1 if IDs overlap, but better references.
  senderRole  String   // "USER" or "ADMIN"
  message     String
  createdAt   DateTime @default(now())
}

model EventLog {
  id          String   @id @default(uuid())
  userId      String?
  event       String   // page_view, checkout_started, etc.
  metadata    String?  // JSON string
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
}

model SystemSetting {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}
